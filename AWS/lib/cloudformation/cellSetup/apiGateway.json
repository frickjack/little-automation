{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Parameters": {
    "CertificateArn": {
      "Type": "String",
      "Description": "ACM Certificate ARN"
    },
    "DomainName": {
      "Type": "String",
      "Description": "custom domain for the gateway - aligns with certificate"
    },
    "StackName": {
      "Type": "String",
      "Description": "deployment stack - ex api.frickjack.com, reuben.dev.frickjack.com, ...",
      "ConstraintDescription": "should usually be the domain of the deployment"
    },
    "StageName": {
      "Type": "String",
      "Description": "dev stage associated with this stack (prod, pre-prod, qa, dev)",
      "Default" : "prod",
      "AllowedValues": [ "prod", "pre-prod", "qa", "dev" ]
    },
    "LambdaBucket": {
      "Type": "String",
      "Description": "bucket of s3 with lambda package",
      "ConstraintDescription": "must be a valid s3 bucket"
    },
    "LambdaKey": {
      "Type": "String",
      "Description": "key of s3 path to lambda package",
      "ConstraintDescription": "must be a valid s3 object key"
    },
    "LambdaLayers": {
      "Type": "CommaDelimitedList",
      "Description": "Lambda layer ARN list",
      "ConstraintDescription": "comma separated list of lambda layer arn's"
    },
    "LambdaRole": {
      "Type": "String",
      "Description": "arn of IAM role for lambda execution to assume",
      "ConstraintDescription": "IAM role arn"
    },
    "LambdaConfig": {
      "Type": "AWS::SSM::Parameter::Value<String>"
    },
    "GatewayRole": {
      "Type": "String",
      "Description": "arn of IAM role for gateway to assume",
      "ConstraintDescription": "IAM role arn"
    }
  },
  "Resources": {
    "apiLambda": {
      "Type" : "AWS::Lambda::Function",
      "Properties" : {
        "Code" : {
          "S3Bucket" : { "Ref": "LambdaBucket" },
          "S3Key" : { "Ref": "LambdaKey" }
        },
        "Description" : "authn functions",
        "Environment" : {
          "Variables": { 
            "LittleMessage": "hello",
            "LITTLE_AUTHN_CONFIG": "{ \"type\": \"env\", \"value\": \"LITTLE_LAMBDA_CONFIG\" }",
            "LITTLE_LAMBDA_CONFIG": {"Ref": "LambdaConfig"}
          }
        },
        "FunctionName" : { "Fn::Join": [ "-", ["api_frickjack_com", { "Ref": "StackName" }, { "Ref": "StageName" }, "authn"]] },
        "Handler" : "index.lambdaHandler",
        "Layers" : { "Ref": "LambdaLayers" },
        "MemorySize" : 256,
        "Role" : { "Ref": "LambdaRole" },
        "Runtime" : "nodejs12.x",
        "Tags": [
          {
              "Key": "org",
              "Value": "applications"
          },
          {
              "Key": "project",
              "Value": "api.frickjack.com"
          },
          {
              "Key": "stack",
              "Value": { "Ref": "StackName" }
          },
          {
              "Key": "stage",
              "Value": { "Ref": "StageName" }
          },
          {
            "Key": "role",
            "Value": "api"
          }
      ],
      "Timeout" : 3,
        "TracingConfig" : {
          "Mode": "Active"
        }
      }
    },
    "lambdaPermission": {
      "Type": "AWS::Lambda::Permission",
      "Properties": {
        "Action": "lambda:invokeFunction",
        "FunctionName": {"Fn::GetAtt": ["apiLambda", "Arn"]},
        "Principal": "apigateway.amazonaws.com",
        "SourceArn": {"Fn::Join": ["", 
          ["arn:aws:execute-api:", {"Ref": "AWS::Region"}, ":", {"Ref": "AWS::AccountId"}, ":", {"Ref": "apiGateway"}, "/*"]
        ]}
      }
    },
    "apiGateway": {
      "Type" : "AWS::ApiGateway::RestApi",
      "Properties" : {
          "Description" : "simple call-through to lambda api",
          "EndpointConfiguration" : {
            "Types": ["EDGE"]
          },
          "MinimumCompressionSize" : 128,
          "Name" : { "Fn::Join": [ "-", ["api_frickjack_com", { "Ref": "StackName" }, { "Ref": "StageName" }]] },
          "Body": {
            "info": "little stack commands insert openapi.yaml here"
          }
        }
    },

    "apiDeploymentWithNullStage": {
      "Type": "AWS::ApiGateway::Deployment",
      "Description": "new deployment with authn",
      "Properties": {
        "RestApiId": {"Ref": "apiGateway"},
        "StageName": "null"
      }
    },

    "apiStage": {
      "Type": "AWS::ApiGateway::Stage",
      "Properties": {
        "DeploymentId": { "Ref": "apiDeploymentWithNullStage" },
        "MethodSettings": [{
          "DataTraceEnabled": true,
          "HttpMethod": "*",
          "LoggingLevel": "INFO",
          "ResourcePath": "/*"
        }],
        "RestApiId": {"Ref": "apiGateway"},
        "StageName": "v1"
      }
    },

    "domainName": {
      "Type" : "AWS::ApiGateway::DomainName",
      "Properties" : {
          "CertificateArn" : { "Ref": "CertificateArn" },
          "DomainName" : { "Ref": "DomainName" },
          "EndpointConfiguration" : { "Types": ["EDGE"] },
          "SecurityPolicy": "TLS_1_2"
        }
    },

    "domainMapping": {
      "Type": "AWS::ApiGateway::BasePathMapping",
      "Properties": {
          "BasePath": "authn",
          "DomainName": {
              "Ref": "DomainName"
          },
          "RestApiId": {
              "Ref": "apiGateway"
          },
          "Stage": "v1"
      }
    }
  },

  "Outputs": {
    "RootUrl": {
      "Description": "Root URL of the API gateway",
      "Value": {"Fn::Join": ["",
        ["https://", {"Ref": "apiGateway"}, ".execute-api.", {"Ref": "AWS::Region"}, ".amazonaws.com"]
      ]}
    }
  }
}
